ALTER PROCEDURE [dbo].[sp_RegisterUser]
    @Action NVARCHAR(20),
    @Id UNIQUEIDENTIFIER = NULL,
    @FirstName NVARCHAR(100) = NULL,
    @LastName NVARCHAR(100) = NULL,
    @BusinessName NVARCHAR(100) = NULL,
    @BusinessCategoryId INT = NULL,
    @City NVARCHAR(100) = NULL,
    @Phone NVARCHAR(100) = NULL,
    @Email NVARCHAR(100) = NULL,
    @PasswordHash NVARCHAR(200) = NULL,
    @Role NVARCHAR(50) = NULL,
    @IsEmailVerified BIT = NULL,
    @Status NVARCHAR(50) = NULL,
    @VerificationToken NVARCHAR(200) = NULL,
    @VerificationTokenExpiry DATETIME = NULL
AS
BEGIN
    -- GET user by email
    IF @Action = 'GET'
    BEGIN
        SELECT * FROM AppUsers WHERE Email = @Email;
    END

	IF @Action = 'GET_BY_ID'
    BEGIN
        SELECT * FROM AppUsers WHERE Id = @Id;
    END

    -- POST register new user
    IF @Action = 'POST'
    BEGIN
        INSERT INTO AppUsers (
            Id, FirstName, LastName, BusinessName, BusinessCategoryId, Email, PasswordHash, Role, City, Phone,
            IsEmailVerified, Status, CreatedAt, EmailVerificationToken, VerificationTokenExpiry
        )
        VALUES (
            @Id, @FirstName, @LastName, @BusinessName, @BusinessCategoryId, @Email, @PasswordHash, @Role, @City, @Phone,
            0, 'Pending', GETDATE(), @VerificationToken, @VerificationTokenExpiry
        );
    END

    -- GET user by token
    IF @Action = 'GET_BY_TOKEN'
    BEGIN
        SELECT * FROM AppUsers WHERE EmailVerificationToken = @VerificationToken;
    END

    -- VERIFY email
    IF @Action = 'VERIFY'
    BEGIN
        UPDATE AppUsers
        SET IsEmailVerified = 1,
            Status = 'Approved',
            EmailVerificationToken = NULL,
            VerificationTokenExpiry = NULL
        WHERE EmailVerificationToken = @VerificationToken;
    END
END
